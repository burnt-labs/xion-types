name: Generate Protobuf Types

on:
  workflow_call:
    inputs:
      release_tag:
        description: "Xion release tag (e.g. v1.2.3) or tag with commit suffix (e.g. v1.2.3-abcd124)."
        required: true
        type: string

  workflow_dispatch:
    inputs:
      release_tag:
        description: "Xion release tag (e.g. v1.2.3) or tag with commit suffix (e.g. v1.2.3-abcd124)."
        required: true
        type: string

jobs:
  generate:
    name: Generate ${{ matrix.language }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language:
          - c
          - cpp
          - csharp
          - docs
          - kotlin
          - objc
          - php
          - python
          - ruby
          - rust
          - scala
          - swift
          - ts
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup xion submodule
        uses: ./.github/actions/setup-xion-version
        with:
          version: ${{ inputs.release_tag }}

      - name: Generate ${{ matrix.language }} definitions
        run: make proto-gen-${{ matrix.language }}

      - name: Check types generated
        run: |
          # Determine output directory (must match buf.gen.<lang>.yaml output paths)
          case "${{ matrix.language }}" in
            python) DIR="python/xion_types" ;;
            ruby)   DIR="ruby/lib/xion_types" ;;
            docs)   DIR="docs" ;;
            *)      DIR="${{ matrix.language }}/types" ;;
          esac

          if [ -d "$DIR" ] && [ "$(ls -A "$DIR")" ]; then
            COUNT=$(find "$DIR" -type f | wc -l)
            echo "✅ ${{ matrix.language }}: $COUNT files generated in $DIR"
          else
            echo "❌ ${{ matrix.language }}: no output in $DIR"
            exit 1
          fi

      # Upload per-language artifacts
      - name: Upload generated types
        if: matrix.language != 'python' && matrix.language != 'docs' && matrix.language != 'kotlin' && matrix.language != 'ruby'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-${{ matrix.language }}
          path: ${{ matrix.language }}/types
          retention-days: 7

      - name: Upload generated Ruby gem
        if: matrix.language == 'ruby'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-ruby
          path: ruby/
          retention-days: 7

      - name: Upload generated Python package
        if: matrix.language == 'python'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-python
          path: python/xion_types
          retention-days: 7

      - name: Upload generated docs
        if: matrix.language == 'docs'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-docs
          path: docs
          retention-days: 7

      # Kotlin uploads both kotlin and java types (post_kotlin generates java too)
      - name: Upload Kotlin types
        if: matrix.language == 'kotlin'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-kotlin
          path: kotlin/types
          retention-days: 7

      - name: Upload Java types (Kotlin dep)
        if: matrix.language == 'kotlin'
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-java
          path: java/types
          retention-days: 7
