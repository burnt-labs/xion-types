name: Ruby Protobuf Gen & Publish

on:
  # push:
  #   branches: 
  #   #   - main 
  #     - feat/protobufs
            
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Specific version to set (e.g., 1.2.3). Required for publishing.'
        required: true
        type: string

  repository_dispatch: # triggers on release event from burnt-labs/xion repo
    types: [xion-types-release-trigger]
    
  schedule:
    - cron: '0 9 * * 5' # Run Fridays at 9 AM UTC

jobs:
  generate-protobuf:
    name: Generate Ruby Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Ruby Definitions
        run: |
          make proto-gen-ruby

      - name: Check if Types Were Generated
        run: |
          if [ -d "./ruby/types" ] && [ "$(ls -A ./ruby/types)" ]; then
            echo "✅ Ruby definitions generated successfully"
            echo "Listing top-level directories:"
            ls -la ruby/types/ | head -20
          else
            echo "❌ Failed to generate Ruby definitions"
            exit 1
          fi

      - name: Upload Generated Types
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-ruby
          path: ruby/types
          retention-days: 30

  determine-version:
    name: Determine Version
    needs: [generate-protobuf]
    runs-on: ubuntu-latest
    if: |
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && (github.event.client_payload.release_type == 'published' || github.event.client_payload.release_type == 'prerelease'))
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        # Version scenarios:
        # 1. Manual trigger (workflow_dispatch) → Use input version (e.g., "1.2.3")
        # 2. Release event (repository_dispatch) → Use release tag (e.g., "v1.2.3" → "1.2.3")
        # 3. Push to branch → Generate dev version (e.g., "0.0.0.dev1234567890")
        id: version
        run: |
          if [ "${{ github.event.inputs.next_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.next_version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_TAG="${{ github.event.client_payload.tag_name }}"
            VERSION=${RELEASE_TAG#v}
            # Safety check: If it's a prerelease but the version string doesn't have a hyphen (no suffix), append -rc.0
            if [ "${{ github.event.client_payload.release_type }}" == "prerelease" ] && [[ "$VERSION" != *-* ]]; then
              echo "⚠️ Prerelease detected without suffix in version $VERSION. Appending -rc.0 for safety."
              VERSION="${VERSION}-rc.0"
            fi
            echo "Using release version: $VERSION (from tag: $RELEASE_TAG)"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            TIMESTAMP=$(date -u +%Y%m%d%H%M)
            VERSION="0.0.0-nightly.${TIMESTAMP}"
            echo "Using nightly version: $VERSION"
          elif [ "${{ github.event_name }}" == "push" ]; then
            TIMESTAMP=$(date +%s)
            VERSION="0.0.0.dev${TIMESTAMP}"
            echo "Using dev version for testing: $VERSION"
          else
            echo "❌ No version specified"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # Ruby Gem Building/Testing
  # ============================================

  ruby-build:
    name: Build Gem
    needs: [determine-version, generate-protobuf]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Ruby Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-ruby
          path: ruby/types

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false  # We'll handle caching manually

      - name: Create Ruby Gem Structure
        run: |
          mkdir -p ruby/lib/xion_types
          
          # Create version file
          cat > ruby/lib/xion_types/version.rb << 'VERSION'
          module XionTypes
            VERSION = "0.1.0"
          end
          VERSION
          
          # Create main module file
          cat > ruby/lib/xion_types.rb << 'MAIN'
          require_relative "xion_types/version"
          
          # Load all generated protobuf types
          Dir[File.join(__dir__, "xion_types", "**", "*.rb")].each do |file|
            require file
          end
          
          module XionTypes
            # Main module for Xion blockchain protocol buffer types
          end
          MAIN
          
          # Create gemspec
          if [ ! -f "ruby/xion_types.gemspec" ]; then
            cat > ruby/xion_types.gemspec << 'GEMSPEC'
          # frozen_string_literal: true

          require_relative "lib/xion_types/version"

          Gem::Specification.new do |spec|
            spec.name          = "xion_types"
            spec.version       = XionTypes::VERSION
            spec.authors       = ["Burnt Labs"]
            spec.email         = ["--ADD-HERE-YOUR-VALUE--"]
            
            spec.summary       = "Generated Ruby types for Xion blockchain protocol buffers"
            spec.description   = "Generated Ruby types for Xion blockchain protocol buffers"
            spec.homepage      = "https://github.com/burnt-labs/xion-types"
            spec.license       = "Apache-2.0"
            
            spec.metadata["homepage_uri"] = spec.homepage
            spec.metadata["source_code_uri"] = spec.homepage
            spec.metadata["changelog_uri"] = "#{spec.homepage}/blob/main/CHANGELOG.md"
            
            # Specify which files should be added to the gem when it is released
            spec.files = Dir.chdir(__dir__) do
              # Include all files from lib directory (including generated protobuf files)
              lib_files = Dir.glob("lib/**/*").select { |f| File.file?(f) }
              # Include gemspec and other root files if they exist
              root_files = %w[Gemfile README.md LICENSE CHANGELOG.md].select { |f| File.exist?(f) }
              (lib_files + root_files).reject do |f|
                f.include?(".git") || f.include?(".github")
              end
            end
            
            spec.bindir        = "exe"
            spec.executables  = spec.files.grep(%r{\Aexe/}) { |f| File.basename(f) }
            spec.require_paths = ["lib"]
            
            # Runtime dependencies
            spec.add_runtime_dependency "google-protobuf", "~> 3.25"
          end
          GEMSPEC
            echo "✅ Created ruby/xion_types.gemspec"
          else
            echo "✅ ruby/xion_types.gemspec already exists"
          fi
          
          # Create Gemfile if it doesn't exist
          if [ ! -f "ruby/Gemfile" ]; then
            cat > ruby/Gemfile << 'GEMFILE'
          # frozen_string_literal: true

          source "https://rubygems.org"

          gemspec
          GEMFILE
            echo "✅ Created ruby/Gemfile"
          else
            echo "✅ ruby/Gemfile already exists"
          fi
          
          # Copy generated types to lib/xion_types directory structure
          echo "Copying generated Ruby types..."
          cp -r ruby/types/* ruby/lib/xion_types/ 2>/dev/null || true
          
          # Ensure all .rb files are properly required
          find ruby/lib/xion_types -name "*.rb" -type f | head -5

      - name: Update Version
        working-directory: ./ruby
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          sed -i "s/VERSION = .*/VERSION = \"$VERSION\"/" lib/xion_types/version.rb
          sed -i "s/spec.version       = .*/spec.version       = XionTypes::VERSION/" xion_types.gemspec
          echo "✅ Updated version to $VERSION"

      - name: Install Dependencies
        working-directory: ./ruby
        run: |
          bundle install
          echo "✅ Dependencies installed"

      - name: Build Gem
        working-directory: ./ruby
        run: |
          gem build xion_types.gemspec
          echo "✅ Gem built successfully"
          ls -lh *.gem

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: ruby-gem
          path: ruby/*.gem
          retention-days: 30

  ruby-test:
    name: Test Ruby ${{ matrix.ruby-version }}
    needs: [ruby-build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['3.0', '3.1', '3.2', '3.3']
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Ruby Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-ruby
          path: ruby/types

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: false

      - name: Create Ruby Gem Structure
        run: |
          mkdir -p ruby/lib/xion_types
          
          # Create version file
          cat > ruby/lib/xion_types/version.rb << 'VERSION'
          module XionTypes
            VERSION = "0.1.0"
          end
          VERSION
          
          # Create main module file
          cat > ruby/lib/xion_types.rb << 'MAIN'
          require_relative "xion_types/version"
          
          # Load all generated protobuf types
          Dir[File.join(__dir__, "xion_types", "**", "*.rb")].each do |file|
            require file
          end
          
          module XionTypes
            # Main module for Xion blockchain protocol buffer types
          end
          MAIN
          
          # Create gemspec
          if [ ! -f "ruby/xion_types.gemspec" ]; then
            cat > ruby/xion_types.gemspec << 'GEMSPEC'
          # frozen_string_literal: true

          require_relative "lib/xion_types/version"

          Gem::Specification.new do |spec|
            spec.name          = "xion_types"
            spec.version       = XionTypes::VERSION
            spec.authors       = ["Burnt Labs"]
            spec.email         = ["--ADD-HERE-YOUR-VALUE--"]
            
            spec.summary       = "Generated Ruby types for Xion blockchain protocol buffers"
            spec.description   = "Generated Ruby types for Xion blockchain protocol buffers"
            spec.homepage      = "https://github.com/burnt-labs/xion-types"
            spec.license       = "Apache-2.0"
            
            spec.metadata["homepage_uri"] = spec.homepage
            spec.metadata["source_code_uri"] = spec.homepage
            spec.metadata["changelog_uri"] = "#{spec.homepage}/blob/main/CHANGELOG.md"
            
            # Specify which files should be added to the gem when it is released
            spec.files = Dir.chdir(__dir__) do
              # Include all files from lib directory (including generated protobuf files)
              lib_files = Dir.glob("lib/**/*").select { |f| File.file?(f) }
              # Include gemspec and other root files if they exist
              root_files = %w[Gemfile README.md LICENSE CHANGELOG.md].select { |f| File.exist?(f) }
              (lib_files + root_files).reject do |f|
                f.include?(".git") || f.include?(".github")
              end
            end
            
            spec.bindir        = "exe"
            spec.executables  = spec.files.grep(%r{\Aexe/}) { |f| File.basename(f) }
            spec.require_paths = ["lib"]
            
            spec.add_runtime_dependency "google-protobuf", "~> 3.25"
          end
          GEMSPEC
            echo "✅ Created ruby/xion_types.gemspec"
          else
            echo "✅ ruby/xion_types.gemspec already exists"
          fi
          
          # Create Gemfile if it doesn't exist
          if [ ! -f "ruby/Gemfile" ]; then
            cat > ruby/Gemfile << 'GEMFILE'
          # frozen_string_literal: true

          source "https://rubygems.org"

          gemspec
          GEMFILE
          fi
          
          # Copy generated types
          cp -r ruby/types/* ruby/lib/xion_types/ 2>/dev/null || true

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: ruby-gem
          path: ruby/

      - name: Install and Test
        working-directory: ./ruby
        env:
          VERSION: ${{ needs.ruby-build.outputs.version }}
          BUNDLE_GEMFILE: ""  # Unset to avoid Bundler interference
        run: |
          # Verify gem structure before installation
          echo "Checking gem contents..."
          gem spec *.gem | grep -A 20 "^files:" || true
          
          # Install the gem to user directory to avoid system conflicts
          gem install *.gem --user-install --no-document
          
          # Get the user gem directory for this Ruby version
          USER_GEM_DIR=$(ruby -e "require 'rubygems'; puts Gem.user_dir")
          echo "User gem directory: $USER_GEM_DIR"
          
          # Find the installed gem's lib directory
          GEM_LIB_DIR=$(find "$USER_GEM_DIR/gems" -name "xion_types-*" -type d | head -1)
          if [ -n "$GEM_LIB_DIR" ]; then
            GEM_LIB_PATH="$GEM_LIB_DIR/lib"
            GEM_XION_TYPES_PATH="$GEM_LIB_PATH/xion_types"
            echo "Found gem lib directory: $GEM_LIB_PATH"
            echo "Found gem xion_types directory: $GEM_XION_TYPES_PATH"
            
            # Add both lib and lib/xion_types to RUBYLIB
            # lib is needed for 'require xion_types', lib/xion_types is needed for 'require cosmos_proto/cosmos_pb'
            export RUBYLIB="$GEM_XION_TYPES_PATH:$GEM_LIB_PATH:${RUBYLIB:-}"
          fi
          
          # Add user gem directory to GEM_PATH so RubyGems can find user-installed gems
          export GEM_PATH="$USER_GEM_DIR:${GEM_PATH:-}"
          
          # Verify gem is installed by checking directory
          if [ -d "$GEM_LIB_DIR" ]; then
            echo "✅ Gem installed at: $GEM_LIB_DIR"
            ls -la "$GEM_LIB_DIR/lib" | head -5
            echo "Checking xion_types subdirectory:"
            ls -la "$GEM_XION_TYPES_PATH" | head -5 || echo "⚠️ xion_types directory not found"
          else
            echo "⚠️ Could not find installed gem directory"
          fi
          
          # Test basic import - add both paths to load path
          if [ -n "$GEM_LIB_PATH" ] && [ -n "$GEM_XION_TYPES_PATH" ]; then
            ruby -I"$GEM_XION_TYPES_PATH" -I"$GEM_LIB_PATH" -e "require 'xion_types'; puts '✅ XionTypes module loaded successfully'"
          else
            ruby -rrubygems -e "Gem.paths.path.unshift('$USER_GEM_DIR'); require 'xion_types'; puts '✅ XionTypes module loaded successfully'"
          fi
          
          # Try to load a specific protobuf type if available
          if [ -n "$GEM_LIB_PATH" ] && [ -n "$GEM_XION_TYPES_PATH" ]; then
            ruby -I"$GEM_XION_TYPES_PATH" -I"$GEM_LIB_PATH" -e "require 'xion_types'; puts '✅ Import successful'" || echo "⚠️ Some types may not be loadable"
          else
            ruby -rrubygems -e "Gem.paths.path.unshift('$USER_GEM_DIR'); require 'xion_types'; puts '✅ Import successful'" || echo "⚠️ Some types may not be loadable"
          fi

  # ============================================
  # Ruby Gem Publishing
  # ============================================

  ruby-publish:
    name: Publish to RubyGems
    needs: [ruby-test, ruby-build]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'repository_dispatch' && (github.event.client_payload.release_type == 'published' || github.event.client_payload.release_type == 'prerelease'))
    permissions:
      contents: read
    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: ruby-gem
          path: ruby/

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Publish to RubyGems
        working-directory: ./ruby
        env:
          RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
        run: |
          if [ -z "$RUBYGEMS_API_KEY" ]; then
            echo "⚠️ RUBYGEMS_API_KEY not set, skipping publish"
            exit 0
          fi
          
          # Verify gem file exists
          if [ ! -f *.gem ]; then
            echo "❌ No .gem file found to publish"
            exit 1
          fi
          
          # Create credentials file for RubyGems.org
          # RubyGems credentials file format: YAML with API key
          # See: https://guides.rubygems.org/publishing/
          mkdir -p ~/.gem
          printf "---\n:rubygems_api_key: %s\n" "$RUBYGEMS_API_KEY" > ~/.gem/credentials
          chmod 600 ~/.gem/credentials
          
          # Publish to RubyGems.org
          # gem push will automatically use credentials from ~/.gem/credentials
          gem push *.gem
          echo "✅ Published to RubyGems.org"
