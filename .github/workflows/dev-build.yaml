name: Dev Build

# Manually trigger a dev build (and optional publish) for one or all languages.
# Uses the xion submodule HEAD or a specific commit/tag to generate types.
# Publishes with a pre-release version like 0.0.0-dev.<sha>.

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language to build (or 'all')"
        required: true
        type: choice
        options:
          - all
          - ts
          - python
          - rust
          - ruby
          - swift
          - kotlin
      xion_ref:
        description: "Xion ref â€” tag (v26.0.0), branch, commit (abc1234), or 'dev' for HEAD"
        required: false
        default: "dev"
        type: string
      base_version:
        description: "Base version override (e.g. v26.1.0). Leave empty to auto-detect from nearest tag."
        required: false
        default: ""
        type: string
      publish:
        description: "Publish to package registry?"
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  # â”€â”€â”€ Resolve version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  resolve:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
      release_tag: ${{ steps.ver.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup xion submodule
        uses: ./.github/actions/setup-xion-version
        with:
          version: ${{ inputs.xion_ref }}

      - name: Set outputs
        id: ver
        run: |
          REF="${{ inputs.xion_ref }}"
          BASE="${{ inputs.base_version }}"
          SHA=$(git -C xion rev-parse --short HEAD)

          if [[ "$REF" == v* ]] && [[ -z "$BASE" ]]; then
            # Explicit tag like v26.0.0 â€” use as-is
            VERSION="${REF#v}"
            TAG="$REF"
          else
            # Commit hash, branch, or "dev" â€” build a pre-release version
            if [[ -n "$BASE" ]]; then
              # User provided base version (e.g. v26.1.0)
              BASE_VER="${BASE#v}"
            else
              # Auto-detect: find nearest tag in xion, bump patch
              NEAREST=$(git -C xion describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
              NEAREST="${NEAREST#v}"
              MAJOR=$(echo "$NEAREST" | cut -d. -f1)
              MINOR=$(echo "$NEAREST" | cut -d. -f2)
              PATCH=$(echo "$NEAREST" | cut -d. -f3)
              BASE_VER="${MAJOR}.${MINOR}.$((PATCH + 1))"
            fi
            VERSION="${BASE_VER}-${SHA}"
            TAG="v${VERSION}"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "release_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Version: $VERSION  Tag: $TAG"

  # â”€â”€â”€ Generate types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate:
    name: Generate
    needs: [resolve]
    uses: ./.github/workflows/generate-protobuf.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  # â”€â”€â”€ Commit to dev branch & tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  commit:
    name: Commit & Tag
    needs: [resolve, generate]
    if: inputs.publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Create dev branch
        run: git checkout -b "dev/${{ needs.resolve.outputs.release_tag }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: generated-types-*
          merge-multiple: false

      # Place each artifact in its correct location
      - name: Organize artifacts
        run: |
          # download-artifact creates dirs named after each artifact
          for dir in generated-types-*/; do
            lang="${dir#generated-types-}"
            lang="${lang%/}"
            case "$lang" in
              python) cp -r "$dir"/* python/xion_types/ 2>/dev/null || mkdir -p python/xion_types && cp -r "$dir"/* python/xion_types/ ;;
              ruby)   cp -r "$dir"/* ruby/ ;;
              *)      mkdir -p "$lang/types" && cp -r "$dir"/* "$lang/types/" ;;
            esac
          done

      - name: Commit & push tag
        env:
          TAG: ${{ needs.resolve.outputs.release_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: dev build $TAG" || echo "No changes"
          git tag "$TAG"
          git push origin "$TAG"
          echo "âœ… Tagged $TAG"

  # â”€â”€â”€ Publish (optional, per-language) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-ts:
    name: Publish TypeScript
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'ts')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-ts.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  publish-python:
    name: Publish Python
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'python')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-python.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  publish-rust:
    name: Publish Rust
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'rust')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-rust.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  publish-ruby:
    name: Publish Ruby
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'ruby')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-ruby.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  publish-swift:
    name: Publish Swift
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'swift')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-swift.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  publish-kotlin:
    name: Publish Kotlin
    if: inputs.publish && (inputs.language == 'all' || inputs.language == 'kotlin')
    needs: [resolve, commit]
    uses: ./.github/workflows/publish-kotlin.yaml
    with:
      release_tag: ${{ needs.resolve.outputs.release_tag }}
    secrets: inherit

  summary:
    name: Summary
    needs: [resolve, generate, commit, publish-ts, publish-python, publish-rust, publish-ruby, publish-swift, publish-kotlin]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report
        run: |
          echo "## Dev Build Summary"
          echo ""
          echo "- **Xion ref:** ${{ inputs.xion_ref }}"
          echo "- **Version:** ${{ needs.resolve.outputs.version }}"
          echo "- **Language:** ${{ inputs.language }}"
          echo "- **Publish:** ${{ inputs.publish }}"
          echo ""
          echo "| Stage | Result |"
          echo "|-------|--------|"
          echo "| Generate | ${{ needs.generate.result }} |"
          if [[ "${{ inputs.publish }}" == "true" ]]; then
            echo "| TypeScript | ${{ needs.publish-ts.result }} |"
            echo "| Python | ${{ needs.publish-python.result }} |"
            echo "| Rust | ${{ needs.publish-rust.result }} |"
            echo "| Ruby | ${{ needs.publish-ruby.result }} |"
            echo "| Swift | ${{ needs.publish-swift.result }} |"
            echo "| Kotlin | ${{ needs.publish-kotlin.result }} |"
          fi
