name: Publish Python Package

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3)'
        required: true
        type: string
      artifact_run_id:
        description: 'Specific workflow run ID to download artifacts from (optional)'
        required: false
        type: string
      skip_publish:
        description: 'Build and test only, skip actual publishing'
        required: false
        type: boolean
        default: false
    secrets:
      PYPI_TOKEN:
        required: true

  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3)'
        required: true
        type: string
      artifact_run_id:
        description: 'Workflow run ID to download artifacts from (leave empty for latest successful run)'
        required: false
        type: string
      skip_publish:
        description: 'Build and test only, skip actual publishing to PyPI'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  download-artifacts:
    name: Download Generated Types
    runs-on: ubuntu-latest
    outputs:
      artifact_downloaded: ${{ steps.download.outputs.success }}
    steps:
      - name: Download from Specific Run
        if: inputs.artifact_run_id != ''
        uses: actions/download-artifact@v4
        id: download_specific
        with:
          name: generated-types-python
          path: python/types
          run-id: ${{ inputs.artifact_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download from Latest Run
        if: inputs.artifact_run_id == ''
        uses: dawidd6/action-download-artifact@v3
        id: download_latest
        with:
          workflow: typescript-ci.yaml
          name: generated-types-python
          path: python/types
          search_artifacts: true
          workflow_conclusion: success
          
      - name: Verify Download
        id: download
        run: |
          if [ -d "python/types" ] && [ "$(ls -A python/types)" ]; then
            echo "âœ… Generated types downloaded successfully"
            echo "Files found: $(find python/types -name '*.py' | wc -l) Python files"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to download generated types"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Types for Next Jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-types-${{ github.run_id }}
          path: python/types
          retention-days: 1

  build-package:
    name: Build Python Package
    needs: [download-artifacts]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      package_name: ${{ steps.build.outputs.package_name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            pyproject.toml
            python/__init__.py
            python/types/__init__.py
            python/README.md
            MANIFEST.in
            LICENSE
            README.md

      - name: Download Generated Types
        uses: actions/download-artifact@v4
        with:
          name: python-types-${{ github.run_id }}
          path: python/types

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Set Version
        id: set_version
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Setting version to: $VERSION"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          sed -i "s/__version__ = .*/__version__ = \"$VERSION\"/" python/__init__.py
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "âœ… Version set to $VERSION"

      - name: Verify Package Structure
        run: |
          echo "=== Package Structure ==="
          echo "Root files:"
          ls -la
          echo ""
          echo "Python package structure:"
          find python -name "*.py" | head -20
          echo "..."
          echo "Total Python files: $(find python -name '*.py' | wc -l)"

      - name: Build Package
        id: build
        run: |
          echo "Building package version: ${{ env.VERSION }}"
          python -m build --wheel --sdist
          
          # Get package filename
          PACKAGE_NAME=$(ls dist/*.whl | head -1 | xargs basename)
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… Package built successfully"
          echo "Files created:"
          ls -lh dist/

      - name: Verify Package Quality
        run: |
          echo "=== Running twine check ==="
          twine check dist/*
          echo "âœ… Package verification passed"

      - name: Inspect Package Contents
        run: |
          echo "=== Package Contents Preview ==="
          echo "Wheel contents:"
          unzip -l dist/*.whl | head -40
          echo "..."
          echo ""
          echo "Source distribution contents:"
          tar -tzf dist/*.tar.gz | head -40
          echo "..."
          echo ""
          echo "Total files in package: $(tar -tzf dist/*.tar.gz | wc -l)"

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-${{ env.VERSION }}
          path: dist/
          retention-days: 30
          if-no-files-found: error

  test-package:
    name: Test on Python ${{ matrix.python-version }}
    needs: [build-package]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
      fail-fast: false
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.build-package.outputs.version }}
          path: dist/

      - name: Install Package
        run: |
          echo "Installing xion-types from wheel..."
          pip install dist/*.whl
          echo "âœ… Package installed successfully"
          
          echo ""
          echo "Installed package info:"
          pip show xion-types

      - name: Test Core Imports
        run: |
          echo "=== Testing Core Imports ==="
          python -c "from types.cosmos.bank.v1beta1 import tx_pb2; print('âœ… cosmos.bank.v1beta1')"
          python -c "from types.abstractaccount.v1 import account_pb2; print('âœ… abstractaccount.v1')"
          python -c "from types.xion.jwk.v1 import tx_pb2; print('âœ… xion.jwk.v1')"
          python -c "from types.cosmos.base.v1beta1 import coin_pb2; print('âœ… cosmos.base.v1beta1')"
          python -c "from types.cosmwasm.wasm.v1 import tx_pb2; print('âœ… cosmwasm.wasm.v1')"
          echo "âœ… All core imports successful"

      - name: Test Message Creation
        run: |
          echo "=== Testing Message Creation ==="
          python << 'EOF'
          from types.cosmos.bank.v1beta1 import tx_pb2
          from types.cosmos.base.v1beta1 import coin_pb2

          # Create a message
          msg = tx_pb2.MsgSend()
          msg.from_address = 'xion1test'
          msg.to_address = 'xion1recipient'
          
          coin = coin_pb2.Coin()
          coin.denom = 'uxion'
          coin.amount = '1000000'
          msg.amount.append(coin)
          
          print(f'âœ… Created MsgSend: from={msg.from_address}, to={msg.to_address}')
          print(f'âœ… Amount: {msg.amount[0].amount} {msg.amount[0].denom}')
          EOF

      - name: Test Serialization
        run: |
          echo "=== Testing Serialization/Deserialization ==="
          python << 'EOF'
          from types.cosmos.bank.v1beta1 import tx_pb2
          from types.cosmos.base.v1beta1 import coin_pb2

          # Create and serialize
          msg1 = tx_pb2.MsgSend()
          msg1.from_address = 'xion1alice'
          msg1.to_address = 'xion1bob'
          msg1.amount.append(coin_pb2.Coin(denom='uxion', amount='5000000'))
          
          data = msg1.SerializeToString()
          print(f'âœ… Serialized to {len(data)} bytes')
          
          # Deserialize
          msg2 = tx_pb2.MsgSend()
          msg2.ParseFromString(data)
          
          assert msg2.from_address == 'xion1alice'
          assert msg2.to_address == 'xion1bob'
          assert msg2.amount[0].amount == '5000000'
          assert msg2.amount[0].denom == 'uxion'
          
          print('âœ… Deserialization successful')
          print('âœ… Round-trip serialization verified')
          EOF

      - name: Test JSON Format
        run: |
          echo "=== Testing JSON Format ==="
          python << 'EOF'
          from google.protobuf import json_format
          from types.cosmos.bank.v1beta1 import tx_pb2
          from types.cosmos.base.v1beta1 import coin_pb2

          msg = tx_pb2.MsgSend()
          msg.from_address = 'xion1test'
          msg.to_address = 'xion1dest'
          msg.amount.append(coin_pb2.Coin(denom='uxion', amount='100'))
          
          # To JSON
          json_str = json_format.MessageToJson(msg)
          print('âœ… Converted to JSON')
          print(json_str[:100] + '...')
          
          # From JSON
          msg2 = json_format.Parse(json_str, tx_pb2.MsgSend())
          assert msg2.from_address == msg.from_address
          
          print('âœ… JSON round-trip successful')
          EOF

      - name: Summary
        run: |
          echo "âœ… All tests passed for Python ${{ matrix.python-version }}"

  publish-to-pypi:
    name: Publish to PyPI
    needs: [build-package, test-package]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_publish }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package-${{ needs.build-package.outputs.version }}
          path: dist/

      - name: Verify Package Contents Before Publishing
        run: |
          echo "=== About to publish ==="
          echo "Version: ${{ needs.build-package.outputs.version }}"
          echo "Package: ${{ needs.build-package.outputs.package_name }}"
          echo ""
          echo "Files to be published:"
          ls -lh dist/
          echo ""
          echo "Wheel contents summary:"
          unzip -l dist/*.whl | tail -20

#       - name: Publish to PyPI
#         uses: pypa/gh-action-pypi-publish@release/v1
#         with:
#           password: ${{ secrets.PYPI_TOKEN }}
#           skip-existing: true
#           verbose: true
#           print-hash: true

#       - name: Publication Success
#         run: |
#           echo "âœ… Successfully published xion-types@${{ needs.build-package.outputs.version }} to PyPI"
#           echo "ðŸ“¦ Package: https://pypi.org/project/xion-types/${{ needs.build-package.outputs.version }}/"

#   verify-publication:
#     name: Verify PyPI Publication
#     needs: [build-package, publish-to-pypi]
#     runs-on: ubuntu-latest
#     if: ${{ !inputs.skip_publish }}
#     steps:
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       - name: Wait for PyPI Propagation
#         run: |
#           echo "â³ Waiting 30 seconds for PyPI to propagate..."
#           sleep 30

#       - name: Verify Package Availability
#         env:
#           VERSION: ${{ needs.build-package.outputs.version }}
#         run: |
#           echo "ðŸ” Verifying xion-types@$VERSION on PyPI..."
          
#           MAX_ATTEMPTS=12
#           ATTEMPT=1
          
#           while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
#             echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
#             # Check if version is available
#             if pip index versions xion-types 2>/dev/null | grep -q "$VERSION"; then
#               echo "âœ… Version $VERSION found on PyPI"
              
#               # Try to install it
#               echo "ðŸ“¥ Installing xion-types==$VERSION..."
#               pip install "xion-types==$VERSION"
              
#               # Verify installation
#               INSTALLED_VERSION=$(pip show xion-types | grep "^Version:" | cut -d' ' -f2)
#               echo "Installed version: $INSTALLED_VERSION"
              
#               if [ "$INSTALLED_VERSION" = "$VERSION" ]; then
#                 echo "âœ… Correct version installed"
#               else
#                 echo "âš ï¸  Version mismatch: expected $VERSION, got $INSTALLED_VERSION"
#               fi
              
#               # Test import
#               python -c "from types.cosmos.bank.v1beta1 import tx_pb2; print('âœ… Import test passed')"
              
#               echo ""
#               echo "ðŸŽ‰ Publication verified successfully!"
#               echo "ðŸ“¦ PyPI: https://pypi.org/project/xion-types/$VERSION/"
#               echo "ðŸ“š Install: pip install xion-types==$VERSION"
              
#               exit 0
#             else
#               echo "â³ Package not yet available (attempt $ATTEMPT/$MAX_ATTEMPTS)"
              
#               if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
#                 echo "Waiting 15 seconds before retry..."
#                 sleep 15
#               fi
#             fi
            
#             ATTEMPT=$((ATTEMPT + 1))
#           done
          
#           echo "âŒ Failed to verify package on PyPI after $MAX_ATTEMPTS attempts"
#           echo "This might be a PyPI propagation delay. Check manually at:"
#           echo "https://pypi.org/project/xion-types/$VERSION/"
#           exit 1

#   summary:
#     name: Publish Summary
#     needs: [build-package, test-package, publish-to-pypi, verify-publication]
#     runs-on: ubuntu-latest
#     if: always()
#     steps:
#       - name: Generate Summary
#         run: |
#           echo "# Python Package Publishing Summary" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## Package Information" >> $GITHUB_STEP_SUMMARY
#           echo "- **Package**: xion-types" >> $GITHUB_STEP_SUMMARY
#           echo "- **Version**: ${{ needs.build-package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Package Name**: ${{ needs.build-package.outputs.package_name }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## Results" >> $GITHUB_STEP_SUMMARY
#           echo "- **Build**: ${{ needs.build-package.result }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Tests**: ${{ needs.test-package.result }}" >> $GITHUB_STEP_SUMMARY
          
#           if [ "${{ inputs.skip_publish }}" = "true" ]; then
#             echo "- **Publish**: â­ï¸ Skipped (skip_publish=true)" >> $GITHUB_STEP_SUMMARY
#           else
#             echo "- **Publish**: ${{ needs.publish-to-pypi.result }}" >> $GITHUB_STEP_SUMMARY
#             echo "- **Verification**: ${{ needs.verify-publication.result }}" >> $GITHUB_STEP_SUMMARY
#           fi
          
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## Links" >> $GITHUB_STEP_SUMMARY
#           echo "- [PyPI Package](https://pypi.org/project/xion-types/)" >> $GITHUB_STEP_SUMMARY
#           echo "- [This Version](https://pypi.org/project/xion-types/${{ needs.build-package.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## Installation" >> $GITHUB_STEP_SUMMARY
#           echo '```bash' >> $GITHUB_STEP_SUMMARY
#           echo "pip install xion-types==${{ needs.build-package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
#           echo '```' >> $GITHUB_STEP_SUMMARY

