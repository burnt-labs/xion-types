name: Publish Python Package

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: "Version to publish (e.g., 1.2.3)"
      artifact_run_id:
        required: false
        type: string
        description: "Specific run ID to download artifacts from"
      skip_publish:
        required: false
        type: boolean
        default: false
        description: "Skip actual PyPI publishing (build and test only)"

env:
  PYTHON_VERSION: '3.11'

jobs:
  download-artifacts:
    name: Download Generated Types
    runs-on: ubuntu-latest
    steps:
      - name: Download Generated Python Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-python
          path: python/types
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.artifact_run_id || github.event.workflow_run.id }}
          
      - name: Verify Downloaded Artifacts
        run: |
          echo "Downloaded artifacts to: python/types"
          ls -R python/types || true
          if [ ! -d "python/types/cosmos" ]; then
            echo "❌ Expected 'python/types/cosmos' directory not found"
            exit 1
          fi
          echo "✅ Artifacts downloaded successfully"

      - name: Upload for Build Job
        uses: actions/upload-artifact@v4
        with:
          name: python-types-for-build
          path: python/types
          retention-days: 1

  build-package:
    name: Build Python Package
    needs: [download-artifacts]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Generated Python Types
        uses: actions/download-artifact@v4
        with:
          name: python-types-for-build
          path: python/types

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Set Version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          echo "Setting version to: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update Version in Files
        run: |
          sed -i "s/^version = .*/version = \"${{ env.VERSION }}\"/" pyproject.toml
          sed -i "s/__version__ = .*/__version__ = \"${{ env.VERSION }}\"/" python/__init__.py
          echo "✅ Updated pyproject.toml and python/__init__.py"

      - name: Build Package
        run: |
          python -m build --wheel --sdist
          echo "✅ Package built successfully"

      - name: Verify Package
        run: |
          twine check dist/*
          echo "✅ Package verification passed"

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 30

  test-package:
    name: Test Python ${{ matrix.python-version }}
    needs: [build-package]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
      fail-fast: false
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      - name: Install Package
        run: |
          pip install dist/*.whl
          echo "✅ Package installed"

      - name: Test Imports
        run: |
          python -c "from types.cosmos.bank.v1beta1 import tx_pb2; print('✅ cosmos.bank.v1beta1')"
          python -c "from types.abstractaccount.v1 import account_pb2; print('✅ abstractaccount.v1')"
          python -c "from types.xion.jwk.v1 import tx_pb2; print('✅ xion.jwk.v1')"
          echo "✅ All imports successful for Python ${{ matrix.python-version }}"

      - name: Test Serialization
        run: |
          python -c "
          from types.cosmos.bank.v1beta1 import tx_pb2
          from types.cosmos.base.v1beta1 import coin_pb2
          
          msg = tx_pb2.MsgSend()
          msg.from_address = 'xion1test'
          msg.to_address = 'xion1recipient'
          
          coin = coin_pb2.Coin()
          coin.denom = 'uxion'
          coin.amount = '1000000'
          msg.amount.append(coin)
          
          data = msg.SerializeToString()
          msg2 = tx_pb2.MsgSend()
          msg2.ParseFromString(data)
          
          assert msg2.from_address == 'xion1test'
          assert msg2.amount[0].amount == '1000000'
          print('✅ Serialization test passed')
          "

  publish-to-pypi:
    name: Publish to PyPI
    needs: [test-package]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_publish }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip-existing: true
          verbose: true

  verify-publication:
    name: Verify PyPI Publication
    needs: [publish-to-pypi, build-package]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_publish }}
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Wait for PyPI
        run: |
          echo "Waiting 30 seconds for PyPI propagation..."
          sleep 30

      - name: Verify Package
        env:
          VERSION: ${{ needs.build-package.outputs.version }}
        run: |
          echo "Verifying xion-types@$VERSION on PyPI..."
          
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if pip index versions xion-types 2>/dev/null | grep -q "$VERSION"; then
              echo "✅ Package xion-types@$VERSION found on PyPI"
              
              pip install "xion-types==$VERSION"
              echo "✅ Package installed from PyPI"
              
              python -c "from types.cosmos.bank.v1beta1 import tx_pb2; print('✅ Import test passed')"
              
              exit 0
            else
              echo "Package not yet available (attempt $ATTEMPT/$MAX_ATTEMPTS)"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                sleep 15
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "❌ Failed to verify package on PyPI"
          exit 1

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build-package, test-package, publish-to-pypi, verify-publication]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Python Package Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.build-package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build**: ${{ needs.build-package.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test**: ${{ needs.test-package.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish-to-pypi.result }}" == "success" ]; then
            echo "**Publish**: ✅ Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install: \`pip install xion-types==${{ needs.build-package.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-to-pypi.result }}" == "skipped" ]; then
            echo "**Publish**: ⏭️ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Publish**: ❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi

