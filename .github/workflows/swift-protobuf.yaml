name: Swift Protobuf Gen & Publish

on:
  push:
    branches: 
    #   - main 
      - dafsdf #feat/protobufs
            
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Specific version to set (e.g., 1.2.3). Required for publishing.'
        required: true
        type: string

  repository_dispatch:
    types: [xion-types-release-trigger]
    
  schedule:
    - cron: '0 2 * * *' # Run nightly at 2 AM UTC

jobs:
  generate-protobuf:
    name: Generate Swift Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Swift Definitions
        run: |
          make proto-gen-swift

      - name: Check if Types Were Generated
        run: |
          if [ -d "./swift/types" ] && [ "$(ls -A ./swift/types)" ]; then
            echo "✅ Swift definitions generated successfully"
          else
            echo "❌ Failed to generate Swift definitions"
            exit 1
          fi

      - name: Upload Generated Types
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-swift
          path: swift/types
          retention-days: 30

  determine-version:
    name: Determine Version
    needs: [generate-protobuf]
    runs-on: ubuntu-latest
    if: |
        github.ref == 'refs/heads/feat/protobufs' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        # Version scenarios:
        # 1. Manual trigger (workflow_dispatch) → Use input version (e.g., "1.2.3")
        # 2. Release event (repository_dispatch) → Use release tag (e.g., "v1.2.3" → "1.2.3")
        # 3. Push to branch → Generate dev version (e.g., "0.0.0.dev1234567890")
        id: version
        run: |
          if [ "${{ github.event.inputs.next_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.next_version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_TAG="${{ github.event.client_payload.tag_name }}"
            VERSION=${RELEASE_TAG#v}
            echo "Using release version: $VERSION (from tag: $RELEASE_TAG)"
          elif [ "${{ github.event_name }}" == "push" ]; then
            TIMESTAMP=$(date +%s)
            VERSION="0.0.0.dev${TIMESTAMP}"
            echo "Using dev version for testing: $VERSION"
          else
            echo "❌ No version specified"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # Swift Package Building/Testing
  # ============================================

  swift-build:
    name: Build Swift Package
    needs: [determine-version, generate-protobuf]
    runs-on: macos-latest
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Swift Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-swift
          path: swift/types

      - name: Create Swift Package Structure
        run: |
          mkdir -p swift/Sources/XionTypes
          
          # Create Package.swift if it doesn't exist
          if [ ! -f "swift/Package.swift" ]; then
            cat > swift/Package.swift << 'PACKAGE'
          // swift-tools-version:5.9
          import PackageDescription

          let package = Package(
              name: "XionTypes",
              platforms: [
                  .iOS(.v13),
                  .macOS(.v10_15),
                  .watchOS(.v6),
                  .tvOS(.v13)
              ],
              products: [
                  .library(
                      name: "XionTypes",
                      targets: ["XionTypes"]
                  ),
              ],
              dependencies: [
                  .package(url: "https://github.com/apple/swift-protobuf.git", from: "1.25.0"),
              ],
              targets: [
                  .target(
                      name: "XionTypes",
                      dependencies: [
                          .product(name: "SwiftProtobuf", package: "swift-protobuf")
                      ],
                      path: "Sources/XionTypes"
                  ),
                  .testTarget(
                      name: "XionTypesTests",
                      dependencies: ["XionTypes"],
                      path: "Tests"
                  ),
              ]
          )
          PACKAGE
            echo "✅ Created swift/Package.swift"
          else
            echo "✅ swift/Package.swift already exists"
          fi
          
          # Copy generated types to Sources/XionTypes
          echo "Copying generated Swift types..."
          cp -r swift/types/* swift/Sources/XionTypes/ 2>/dev/null || true
          
          # Create version file
          cat > swift/Sources/XionTypes/Version.swift << 'VERSION'
          // Generated version file
          public enum XionTypesVersion {
              public static let version = "0.1.0"
          }
          VERSION

      - name: Update Version
        working-directory: ./swift
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          sed -i '' "s/version = .*/version = \"$VERSION\"/" Package.swift 2>/dev/null || sed -i "s/version = .*/version = \"$VERSION\"/" Package.swift
          sed -i '' "s/static let version = .*/static let version = \"$VERSION\"/" Sources/XionTypes/Version.swift 2>/dev/null || sed -i "s/static let version = .*/static let version = \"$VERSION\"/" Sources/XionTypes/Version.swift
          echo "✅ Updated version to $VERSION"

      - name: Build Swift Package
        working-directory: ./swift
        run: |
          swift build
          echo "✅ Swift package built successfully"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: swift-package
          path: swift/
          retention-days: 30

  swift-test:
    name: Test Swift Package
    needs: [swift-build]
    runs-on: macos-latest
    strategy:
      matrix:
        swift-version: ['5.9', '5.10']
      fail-fast: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Swift Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-swift
          path: swift/types

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: swift-package
          path: swift/

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift-version }}

      - name: Create Swift Package Structure
        run: |
          mkdir -p swift/Sources/XionTypes
          cp -r swift/types/* swift/Sources/XionTypes/ 2>/dev/null || true

      - name: Test Swift Package
        working-directory: ./swift
        env:
          VERSION: ${{ needs.swift-build.outputs.version }}
        run: |
          swift test
          echo "✅ Swift package tests passed"

  # ============================================
  # Swift Package Publishing
  # ============================================
  # Note: Swift Package Manager packages are distributed via Git tags.
  # Publishing means creating a Git tag, which is typically done via releases.
  # For CocoaPods, see swift-cocoapods-publish job below.

  swift-cocoapods-publish:
    name: Publish to CocoaPods
    needs: [swift-test, swift-build]
    runs-on: macos-latest
    # TODO: Remove push from condition after testing
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    permissions:
      contents: read
    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: swift-package
          path: swift/

      - name: Setup CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version

      - name: Create Podspec
        working-directory: ./swift
        env:
          VERSION: ${{ needs.swift-build.outputs.version }}
        run: |
          cat > XionTypes.podspec << 'PODSPEC'
          Pod::Spec.new do |spec|
            spec.name         = "XionTypes"
            spec.version      = "--ADD-HERE-YOUR-VALUE--"
            spec.summary      = "Generated Swift types for Xion blockchain protocol buffers"
            spec.description  = "Generated Swift types for Xion blockchain protocol buffers"
            spec.homepage     = "https://github.com/burnt-labs/xion-types"
            spec.license      = { :type => "Apache-2.0" }
            spec.author       = { "Burnt Labs" => "--ADD-HERE-YOUR-VALUE--" }
            
            spec.source       = { :git => "https://github.com/burnt-labs/xion-types.git", :tag => "#{spec.version}" }
            spec.source_files = "Sources/XionTypes/**/*.swift"
            spec.platform     = :ios, "13.0"
            spec.platform     = :osx, "10.15"
            spec.platform     = :watchos, "6.0"
            spec.platform     = :tvos, "13.0"
            
            spec.dependency "SwiftProtobuf", "~> 1.25"
            
            spec.swift_version = "5.9"
          end
          PODSPEC
          
          sed -i '' "s/--ADD-HERE-YOUR-VALUE--/$VERSION/" XionTypes.podspec 2>/dev/null || sed -i "s/--ADD-HERE-YOUR-VALUE--/$VERSION/" XionTypes.podspec
          echo "✅ Created XionTypes.podspec"

      # - name: Publish to CocoaPods Trunk
      #   working-directory: ./swift
      #   env:
      #     COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      #   run: |
      #     if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
      #       echo "⚠️ COCOAPODS_TRUNK_TOKEN not set, skipping publish"
      #       exit 0
      #     fi
      #     
      #     pod trunk push XionTypes.podspec
      #     echo "✅ Published to CocoaPods Trunk"

