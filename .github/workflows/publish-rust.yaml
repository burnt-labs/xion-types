name: Publish Rust to crates.io

on:
  workflow_call:
    inputs:
      release_tag:
        required: true
        type: string

jobs:
  build:
    name: Build Crate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build
        env:
          VERSION: ${{ inputs.release_tag }}
        run: |
          VERSION="${VERSION#v}"
          cd rust
          python3 ../scripts/rust/setup-rust-types.py
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          cargo build --release
          cargo package --allow-dirty

      - name: Upload rust source
        uses: actions/upload-artifact@v4
        with:
          name: rust-source
          path: rust/
          retention-days: 1

  test:
    name: Test (Rust ${{ matrix.rust }})
    needs: [build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: ["1.72", "1.75", "stable"]
    steps:
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - name: Download rust source
        uses: actions/download-artifact@v4
        with:
          name: rust-source
          path: rust/

      - name: Test
        run: |
          cd rust
          cargo test --verbose
          cargo check --verbose

  publish:
    name: Publish to crates.io
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Download rust source
        uses: actions/download-artifact@v4
        with:
          name: rust-source
          path: rust/

      - name: Publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATESIO_ACCESS_TOKEN }}
        run: |
          cd rust
          cargo publish --allow-dirty
