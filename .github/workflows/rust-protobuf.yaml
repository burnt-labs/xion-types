name: Rust Protobuf Generation & Publishing

on:
  push:
    branches: 
    #   - main 
      - feat/protobufs
            
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Specific version to set (e.g., 1.2.3). Required for publishing.'
        required: true
        type: string

  repository_dispatch:
    types: [xion-types-release-trigger]
    
  schedule:
    - cron: '0 2 * * *' # Run nightly at 2 AM UTC

jobs:
  generate-protobuf:
    name: Generate Rust Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Rust Definitions
        run: |
          make proto-gen-rust

      - name: Check if Types Were Generated
        run: |
          if [ -d "./rust/types" ] && [ "$(ls -A ./rust/types)" ]; then
            echo "✅ Rust definitions generated successfully"
          else
            echo "❌ Failed to generate Rust definitions"
            exit 1
          fi

      - name: Upload Generated Types
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types
          retention-days: 30

  determine-version:
    name: Determine Version
    needs: [generate-protobuf]
    runs-on: ubuntu-latest
    if: |
        github.ref == 'refs/heads/feat/protobufs' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        # Version scenarios:
        # 1. Manual trigger (workflow_dispatch) → Use input version (e.g., "1.2.3")
        # 2. Release event (repository_dispatch) → Use release tag (e.g., "v1.2.3" → "1.2.3")
        # 3. Push to branch → Generate dev version (e.g., "0.0.0-dev.abc1234")
        id: version
        run: |
          if [ "${{ github.event.inputs.next_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.next_version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_TAG="${{ github.event.client_payload.tag_name }}"
            VERSION=${RELEASE_TAG#v}
            echo "Using release version: $VERSION (from tag: $RELEASE_TAG)"
          elif [ "${{ github.event_name }}" == "push" ]; then
            GIT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev.${GIT_SHA}"
            echo "Using dev version for testing: $VERSION"
          else
            echo "❌ No version specified"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # Rust Crate Publishing
  # ============================================

  rust-build:
    name: Build Rust Crate
    needs: [determine-version, generate-protobuf]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Rust Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: false  # Disable auto-cache, we'll handle it manually

      - name: Create Rust Package Structure
        run: |
          mkdir -p rust/src
          # Create lib.rs that includes generated types
          cat > rust/src/lib.rs << 'LIB'
          //! Generated Rust types for Xion blockchain protocol buffers
          
          // Include generated protobuf modules
          pub mod types {
              // Include all generated .rs files from types directory
              include!(concat!(env!("CARGO_MANIFEST_DIR"), "/types/mod.rs"));
          }
          LIB
          
          # Create Cargo.toml
          if [ ! -f "rust/Cargo.toml" ]; then
            cat > rust/Cargo.toml << 'CARGO'
          [package]
          name = "xion-types"
          version = "0.1.0"
          edition = "2021"
          description = "Generated Rust types for Xion blockchain protocol buffers"
          license = "Apache-2.0"
          repository = "https://github.com/burnt-labs/xion-types"
          
          [lib]
          name = "xion_types"
          path = "src/lib.rs"
          
          [dependencies]
          prost = "0.12"
          prost-types = "0.12"
          CARGO
            echo "✅ Created rust/Cargo.toml"
          else
            echo "✅ rust/Cargo.toml already exists"
          fi
          
          # Create a mod.rs if it doesn't exist
          if [ ! -f "rust/types/mod.rs" ]; then
            echo "// Auto-generated module" > rust/types/mod.rs
            echo "pub mod cosmos;" >> rust/types/mod.rs 2>/dev/null || true
            echo "pub mod xion;" >> rust/types/mod.rs 2>/dev/null || true
            echo "✅ Created rust/types/mod.rs"
          fi

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './rust'

      - name: Update Version
        working-directory: ./rust
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          echo "✅ Updated Cargo.toml with version $VERSION"

      - name: Build Crate
        working-directory: ./rust
        run: |
          cargo build --release
          echo "✅ Crate built successfully"

      - name: Package Crate
        working-directory: ./rust
        run: |
          cargo package --allow-dirty
          echo "✅ Crate packaged successfully"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: rust-crate
          path: rust/target/package/*.crate
          retention-days: 30

  rust-test:
    name: Test Rust ${{ matrix.rust-version }}
    needs: [rust-build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: ['1.70', '1.75', 'stable']
      fail-fast: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Rust Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust-version }}
          cache: false  # Disable auto-cache, we'll handle it manually

      - name: Create Rust Package Structure
        run: |
          mkdir -p rust
          if [ ! -f "rust/Cargo.toml" ]; then
            cat > rust/Cargo.toml << 'CARGO'
          [package]
          name = "xion-types"
          version = "0.1.0"
          edition = "2021"
          description = "Generated Rust types for Xion blockchain protocol buffers"
          license = "Apache-2.0"
          repository = "https://github.com/burnt-labs/xion-types"
          
          [lib]
          name = "xion_types"
          path = "src/lib.rs"
          
          [dependencies]
          prost = "0.12"
          prost-types = "0.12"
          CARGO
            echo "✅ Created rust/Cargo.toml"
          else
            echo "✅ rust/Cargo.toml already exists"
          fi
          
          # Create src/lib.rs if it doesn't exist
          mkdir -p rust/src
          if [ ! -f "rust/src/lib.rs" ]; then
            cat > rust/src/lib.rs << 'LIB'
          //! Generated Rust types for Xion blockchain protocol buffers
          
          pub mod types {
              include!(concat!(env!("CARGO_MANIFEST_DIR"), "/types/mod.rs"));
          }
          LIB
            echo "✅ Created rust/src/lib.rs"
          fi
          
          # Generate mod.rs dynamically based on existing directories/files
          echo "// Auto-generated module - includes all generated protobuf types" > rust/types/mod.rs
          # Find all .rs files and directories in types/, generate mod declarations
          cd rust/types
          for item in */; do
            if [ -d "$item" ]; then
              dirname=$(basename "$item")
              # Check if directory has .rs files
              if [ "$(ls -A $item/*.rs 2>/dev/null | wc -l)" -gt 0 ]; then
                # Create mod.rs for this subdirectory if it doesn't exist
                if [ ! -f "${item}mod.rs" ]; then
                  echo "// Auto-generated module for ${dirname}" > "${item}mod.rs"
                  # Include all .rs files in this subdirectory
                  for rsfile in "${item}"*.rs; do
                    if [ -f "$rsfile" ] && [ "$(basename "$rsfile")" != "mod.rs" ]; then
                      modname=$(basename "$rsfile" .rs)
                      echo "pub mod ${modname};" >> "${item}mod.rs"
                    fi
                  done
                  echo "✅ Created ${item}mod.rs"
                fi
                # Add to parent mod.rs
                echo "pub mod ${dirname};" >> mod.rs
              fi
            fi
          done
          # Also include any direct .rs files (not in subdirectories)
          for file in *.rs; do
            if [ -f "$file" ] && [ "$file" != "mod.rs" ]; then
              modname=$(basename "$file" .rs)
              echo "pub mod ${modname};" >> mod.rs
            fi
          done
          cd ../..
          echo "✅ Generated rust/types/mod.rs"

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './rust'

      - name: Update Version
        working-directory: ./rust
        env:
          VERSION: ${{ needs.rust-build.outputs.version }}
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml

      - name: Run Tests
        working-directory: ./rust
        run: |
          cargo test --verbose
          echo "✅ Tests passed for Rust ${{ matrix.rust-version }}"

      - name: Check Build
        working-directory: ./rust
        run: |
          cargo check --verbose
          echo "✅ Build check passed for Rust ${{ matrix.rust-version }}"

  # Placeholder for publishing to crates.io
  # rust-publish:
  #   name: Publish to crates.io
  #   needs: [rust-test]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Publish Crate
  #       working-directory: ./rust
  #       env:
  #         CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
  #       run: |
  #         cargo publish --allow-dirty

