name: Rust Protobuf Gen & Publish

on:
  # push:
  #   branches: 
  #     - fix/rust-protobuf-build
            
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Specific version to set (e.g., 1.2.3). Required for publishing.'
        required: true
        type: string

  repository_dispatch: # triggers on release event from burnt-labs/xion repo
    types: [xion-types-release-trigger]
    
  schedule:
    - cron: '0 9 * * 5' # Run Fridays at 9 AM UTC

jobs:
  generate-protobuf:
    name: Generate Rust Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Rust Definitions
        run: |
          make proto-gen-rust

      - name: Check if Types Were Generated
        run: |
          if [ -d "./rust/types" ] && [ "$(ls -A ./rust/types)" ]; then
            echo "✅ Rust definitions generated successfully"
          else
            echo "❌ Failed to generate Rust definitions"
            exit 1
          fi

      - name: Upload Generated Types
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types
          retention-days: 30

  determine-version:
    name: Determine Version
    needs: [generate-protobuf]
    runs-on: ubuntu-latest
    if: |
        github.event_name == 'push' ||    
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && (github.event.client_payload.release_type == 'published' || github.event.client_payload.release_type == 'prerelease'))
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        # Version scenarios:
        # 1. Manual trigger (workflow_dispatch) → Use input version (e.g., "1.2.3")
        # 2. Release event (repository_dispatch) → Use release tag (e.g., "v1.2.3" → "1.2.3")
        # 3. Push to branch → Generate dev version (e.g., "0.0.0-dev.abc1234")
        id: version
        run: |
          if [ "${{ github.event.inputs.next_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.next_version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_TAG="${{ github.event.client_payload.tag_name }}"
            VERSION=${RELEASE_TAG#v}
            # Safety check: If it's a prerelease but the version string doesn't have a hyphen (no suffix), append -rc.0
            if [ "${{ github.event.client_payload.release_type }}" == "prerelease" ] && [[ "$VERSION" != *-* ]]; then
              echo "⚠️ Prerelease detected without suffix in version $VERSION. Appending -rc.0 for safety."
              VERSION="${VERSION}-rc.0"
            fi
            echo "Using release version: $VERSION (from tag: $RELEASE_TAG)"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            TIMESTAMP=$(date -u +%Y.%m.%d.%H.%M)
            VERSION="0.0.0-nightly.${TIMESTAMP}"
            echo "Using nightly version: $VERSION"
          elif [ "${{ github.event_name }}" == "push" ]; then
            GIT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0-dev.${GIT_SHA}"
            echo "Using dev version for testing: $VERSION"
          else
            echo "❌ No version specified"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # Rust Crate Publishing
  # ============================================

  rust-build:
    name: Build Rust Crate
    needs: [determine-version, generate-protobuf]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Rust Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: false  # Disable auto-cache, we'll handle it manually

      - name: Create Rust Package Structure
        run: |
          mkdir -p rust/src
          python3 scripts/setup-rust-types.py

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './rust'

      - name: Update Version
        working-directory: ./rust
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          echo "✅ Updated Cargo.toml with version $VERSION"

      - name: Build Crate
        working-directory: ./rust
        run: |
          cargo build --release
          echo "✅ Crate built successfully"

      - name: Package Crate
        working-directory: ./rust
        run: |
          cargo package --allow-dirty
          echo "✅ Crate packaged successfully"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: rust-crate
          path: rust/target/package/*.crate
          retention-days: 30

      - name: Upload Rust Source Directory
        uses: actions/upload-artifact@v4
        with:
          name: rust-source
          path: rust
          retention-days: 30

  rust-test:
    name: Test Rust ${{ matrix.rust-version }}
    needs: [rust-build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: ['1.72', '1.75', 'stable']
      fail-fast: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Rust Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-rust
          path: rust/types

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust-version }}
          cache: false  # Disable auto-cache, we'll handle it manually

      - name: Create Rust Package Structure
        run: |
          mkdir -p rust/src
          python3 scripts/setup-rust-types.py

      - name: Cache Rust Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './rust'

      - name: Update Version
        working-directory: ./rust
        env:
          VERSION: ${{ needs.rust-build.outputs.version }}
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml

      - name: Run Tests
        working-directory: ./rust
        run: |
          cargo test --verbose
          echo "✅ Tests passed for Rust ${{ matrix.rust-version }}"

      - name: Check Build
        working-directory: ./rust
        run: |
          cargo check --verbose
          echo "✅ Build check passed for Rust ${{ matrix.rust-version }}"

  rust-publish:
    name: Publish to crates.io
    needs: [rust-test, rust-build]
    runs-on: ubuntu-latest
    if: |
        github.event_name == 'push' || 
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    steps:
      - name: Download Rust Source Directory
        uses: actions/download-artifact@v4
        with:
          name: rust-source
          path: rust
  
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: false
  
      - name: Update Version
        working-directory: ./rust
        env:
          VERSION: ${{ needs.rust-build.outputs.version }}
        run: |
          if [ -z "$VERSION" ]; then
            echo "❌ Error: VERSION is empty. Cannot publish without a version."
            exit 1
          fi
          echo "Setting version to: $VERSION"
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml
          echo "✅ Updated Cargo.toml with version $VERSION"
  
    #   - name: Dry Run Publish
    #     working-directory: ./rust
    #     env:
    #       CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    #     run: |
    #       cargo publish --dry-run --allow-dirty
    #       echo "✅ Dry run successful"
  
      - name: Publish Crate
        working-directory: ./rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATESIO_ACCESS_TOKEN }}
        run: |
          cargo publish --allow-dirty
          echo "✅ Crate published successfully [check: https://crates.io/crates/xion-types/versions]"
