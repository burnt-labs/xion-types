name: Python Protobuf Gen & Publish

on:
  # push: #TODO comment when done with testing
  #   branches: 
  #   #   - main 
  #     - feat/fix-protobuf-builds
            
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Specific version to set (e.g., 1.2.3). Required for publishing.'
        required: true
        type: string

  repository_dispatch:
    types: [xion-types-release-trigger]
    
  schedule:
    - cron: '0 2 * * *' # Run nightly at 2 AM UTC

jobs:
  generate-protobuf:
    name: Generate Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Python Definitions
        run: |
          make proto-gen-python

      - name: Check if Types Were Generated
        run: |
          if [ -d "./python/types" ] && [ "$(ls -A ./python/types)" ]; then
            echo "✅ Python definitions generated successfully"
            echo "Listing top-level directories:"
            ls -la python/types/
          else
            echo "❌ Failed to generate Python definitions"
            exit 1
          fi

      - name: Fix Imports (convert absolute to relative)
        run: |
          echo "Fixing Python imports to be relative..."
          
          # Install protoc tools for generating stubs
          pip install grpcio-tools
          
          # Copy to temp location with write permissions
          cp -r python/types python/types_temp
          chmod -R u+w python/types_temp
          
          python3 << 'EOF'
          import os
          import re
          from pathlib import Path
          
          # Packages to convert from absolute imports to xion_types.* imports
          packages = [
              'gogoproto', 'cosmos_proto', 'cosmos', 'cosmwasm', 'xion', 'abstractaccount',
              'amino', 'ibc', 'tendermint', 'osmosis', 'packetforward'
          ]
          
          # Regex patterns for each package
          # Convert to absolute imports within xion_types package
          patterns = []
          for pkg in packages:
              # Match: from package import ...
              patterns.append((
                  re.compile(f'^(\\s*)from {pkg} import', re.MULTILINE),
                  f'\\1from xion_types.{pkg} import'
              ))
              # Match: from package.submodule ...
              patterns.append((
                  re.compile(f'^(\\s*)from {pkg}\\.', re.MULTILINE),
                  f'\\1from xion_types.{pkg}.'
              ))
          
          # Process all Python files in temp location
          types_dir = Path('python/types_temp')
          for py_file in types_dir.rglob('*.py'):
              content = py_file.read_text()
              original = content
              
              for pattern, replacement in patterns:
                  content = pattern.sub(replacement, content)
              
              if content != original:
                  py_file.write_text(content)
                  print(f"Fixed imports in: {py_file}")
          
          print("✅ Import fixing complete")
          EOF
          
          # Create gogoproto stub since buf doesn't generate it for Python
          echo "Creating gogoproto stub..."
          mkdir -p python/types_temp/gogoproto
          cat > python/types_temp/gogoproto/gogo.proto << 'GOGO'
          syntax = "proto3";
          package gogoproto;
          GOGO
          python3 -m grpc_tools.protoc --python_out=python/types_temp --proto_path=python/types_temp python/types_temp/gogoproto/gogo.proto 2>&1 || echo "gogoproto generation completed"
          cat > python/types_temp/gogoproto/__init__.py << 'GOGO'
          """Stub for gogoproto - not used in Python protobuf"""
          GOGO
          
          # Create cosmos_proto stub
          echo "Creating cosmos_proto stub..."
          mkdir -p python/types_temp/cosmos_proto
          cat > python/types_temp/cosmos_proto/cosmos.proto << 'COSMOS'
          syntax = "proto3";
          package cosmos_proto;
          COSMOS
          python3 -m grpc_tools.protoc --python_out=python/types_temp --proto_path=python/types_temp python/types_temp/cosmos_proto/cosmos.proto 2>&1 || echo "cosmos_proto generation completed"
          cat > python/types_temp/cosmos_proto/__init__.py << 'COSMOS'
          """Stub for cosmos_proto - not used in Python protobuf"""
          COSMOS
          
          # Fix imports in stub files too (if any)
          if [ -f "python/types_temp/gogoproto/gogo_pb2.py" ]; then
            sed -i'' 's/^from gogoproto/from xion_types.gogoproto/g' python/types_temp/gogoproto/gogo_pb2.py || true
          fi
          if [ -f "python/types_temp/cosmos_proto/cosmos_pb2.py" ]; then
            sed -i'' 's/^from cosmos_proto/from xion_types.cosmos_proto/g' python/types_temp/cosmos_proto/cosmos_pb2.py || true
          fi
          
          # Create __init__.py in all subdirectories to make them Python packages
          echo "Creating __init__.py files..."
          find python/types_temp -type d -exec touch {}/__init__.py \;
          
          # Remove any existing xion_types directory from repo (ignore errors)
          rm -rf python/xion_types || true
          # Rename temp to xion_types to avoid 'types' namespace collision
          mv python/types_temp python/xion_types
          # Leave python/types in place (it will be ignored by .gitignore)
          echo "✅ Fixed imports and moved to xion_types package"

      - name: Upload Generated Types 
        uses: actions/upload-artifact@v4
        with:
          name: generated-types-python
          path: python/xion_types
          retention-days: 30

  # calculates what version number to use for the package based on how the workflow was triggered
  determine-version:
    name: Determine Version
    needs: [generate-protobuf]
    runs-on: ubuntu-latest
    if: | 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.next_version != '') || 
        (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        # Version scenarios:
        # 1. Manual trigger (workflow_dispatch) → Use input version (e.g., "1.2.3")
        # 2. Release event (repository_dispatch) → Use release tag (e.g., "v1.2.3" → "1.2.3")
        # 3. Push to branch → Generate dev version (e.g., "0.0.0.dev1234567890")
        id: version
        run: |
          if [ "${{ github.event.inputs.next_version }}" != "" ]; then
            VERSION="${{ github.event.inputs.next_version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            RELEASE_TAG="${{ github.event.client_payload.tag_name }}"
            VERSION=${RELEASE_TAG#v}
            echo "Using release version: $VERSION (from tag: $RELEASE_TAG)"
          elif [ "${{ github.event_name }}" == "push" ]; then
            TIMESTAMP=$(date +%s)
            VERSION="0.0.0.dev${TIMESTAMP}"
            echo "Using dev version for testing: $VERSION"
          else
            echo "❌ No version specified"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # Python Package Building/testing
  # ============================================

  python-build:
    name: Build Package
    needs: [determine-version, generate-protobuf]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.determine-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Generated Python Types
        uses: actions/download-artifact@v4
        with:
          name: generated-types-python
          path: python/xion_types

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update Version
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
        run: |
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          
          # Ensure package has a deterministic version module (the generated protobuf tree
          # only guarantees empty __init__.py files).
          mkdir -p python/xion_types
          cat > python/xion_types/_version.py <<'EOF'
          __version__ = "0.0.0"
          EOF
          sed -i "s/^__version__ = .*/__version__ = \"$VERSION\"/" python/xion_types/_version.py

          # Ensure package root exports __version__
          if [ ! -f python/xion_types/__init__.py ]; then
            touch python/xion_types/__init__.py
          fi
          if ! grep -q "^from \\.\\_version import __version__$" python/xion_types/__init__.py; then
            printf "\nfrom ._version import __version__\n" >> python/xion_types/__init__.py
          fi

      - name: Build Package
        run: |
          python -m build --wheel --sdist
          twine check dist/*

      - name: Verify Package Contents
        run: |
          echo "Checking what's in the wheel:"
          unzip -l dist/*.whl | grep -E "gogoproto|xion_types/" | head -20
          echo "---"
          echo "Checking if gogoproto exists:"
          unzip -l dist/*.whl | grep gogoproto || echo "⚠️ gogoproto not found in wheel"

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 30

  python-test:
    name: Test Python ${{ matrix.python-version }}
    needs: [python-build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      - name: Install and Test
        run: |
          pip install dist/*.whl
          python -c "from xion_types.cosmos.bank.v1beta1 import tx_pb2; print('✅ Import successful')"

  # ============================================
  # Python Package Publishing
  # ============================================

  python-publish:
    name: Publish to PyPI
    needs: [python-test, python-build]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'repository_dispatch' && github.event.client_payload.release_type == 'published')
    permissions:
      id-token: write  # Required for trusted publishing
      contents: read
    steps:
      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip-existing: true
          verbose: true